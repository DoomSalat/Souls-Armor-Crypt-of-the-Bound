# 🧠 Архитектура Умного Спауна Врагов

## 📋 Обзор Рефакторинга

### ✅ **Выполненные Задачи:**
1. ✅ Создан `SpawnerEnemysAI` скрипт с AI логикой
2. ✅ Перенесена AI логика из `SpawnerTokens` в `SpawnerEnemysAI`
3. ✅ Упрощен `SpawnerTokens` до подсчета весов
4. ✅ Добавлена система глюков в AI
5. ✅ Обновлен `SpawnerEnemys` для использования нового AI

---

## 🏗️ Новая Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    SpawnerEnemys                            │
│                   (Координатор)                            │
├─────────────────────────────────────────────────────────────┤
│  • SpawnBlue()     • SpawnGreen()    • SpawnRed()          │
│  • SpawnYellow()  • SpawnKnight()   • RequestSoulSpawn()   │
│  • SpawnEnemyManually()                                    │
└─────────────────┬───────────────────┬─────────────────────┘
                  │                   │
                  ▼                   ▼
┌─────────────────────────┐  ┌─────────────────────────┐
│    SpawnerEnemysAI      │  │     SpawnerTokens       │
│      (AI Логика)        │  │    (Подсчет Весов)      │
├─────────────────────────┤  ├─────────────────────────┤
│ • SelectSection()        │  │ • GetSectionWeights()    │
│ • SuggestComplementary()│  │ • GetEnemyCountsBySection│
│ • CommitSectionPower()  │  │ • GetKindWeight()        │
│ • ForceRetarget()       │  │ • Commit() / Release()   │
│ • GLITCH SYSTEM 🎲      │  │ • GetSpawnPosition()     │
│   - Random sections     │  │ • Update() decay         │
│   - Cooldown system     │  │                         │
│   - Debug controls      │  │                         │
└─────────────────────────┘  └─────────────────────────┘
```

---

## 🎯 **SpawnerEnemysAI** - Умный AI

### **Основные Функции:**
- **Выбор секторов** с AI логикой
- **Комплементарный анализ** врагов
- **Система глюков** для непредсказуемости
- **Отладочные инструменты**

### **Система Глюков 🎲:**
```csharp
[SerializeField, Range(0, 1)] private float _glitchChance = 0.05f;  // 5% шанс
[SerializeField, MinValue(0)] private float _glitchCooldown = 2f;    // Кулдаун 2 сек
```

**Логика глюков:**
1. **Проверка кулдауна** - не чаще чем раз в 2 секунды
2. **Случайный шанс** - 5% вероятность срабатывания
3. **Полностью случайный сектор** - игнорирует всю AI логику
4. **Отладочные кнопки** - Force Glitch, Force Retarget

### **AI Алгоритмы:**
- **Противоположная сторона** - спаун напротив наименее загруженного сектора
- **Комплементарный анализ** - умные комбинации врагов
- **Отклонение** - случайное смещение для разнообразия

---

## ⚖️ **SpawnerTokens** - Система Весов

### **Упрощенная Роль:**
- **Подсчет весов** секторов
- **Отслеживание врагов** по секторам
- **Decay система** - автоматическое снижение весов
- **Позиционирование** - расчет позиций спауна

### **Новые Методы для AI:**
```csharp
public float[] GetSectionWeights()                    // Веса всех секторов
public float GetSectionWeight(int sectionIndex)       // Вес конкретного сектора
public int[] GetEnemyCountsBySection(SpawnSection)   // Количество врагов в секторе
public int GetEnemyCountBySectionAndKind(...)        // Количество конкретного типа
```

---

## 🔄 **SpawnerEnemys** - Обновленный Координатор

### **Новые Зависимости:**
```csharp
[RequireComponent(typeof(SpawnerTokens), typeof(SpawnerEnemysAI))]
```

### **Обновленная Логика:**
```csharp
// Старый код:
var section = _spawnerTokens.SelectSection();

// Новый код:
var section = _spawnerAI.SelectSection();
_spawnerAI.CommitSectionPower(section, power);
```

---

## 🎮 **Система Глюков - Детали**

### **Настройки:**
- **Glitch Chance**: 0-100% вероятность срабатывания
- **Glitch Cooldown**: минимальное время между глюками
- **Debug Controls**: кнопки для тестирования

### **Поведение:**
1. **Обычный режим** - AI выбирает оптимальный сектор
2. **Глюк сработал** - полностью случайный сектор
3. **Кулдаун** - защита от слишком частых глюков
4. **Отладка** - принудительное срабатывание глюков

### **Отладочные Кнопки:**
- **Force Glitch** - принудительный глюк
- **Force Retarget** - принудительная смена цели
- **Show Current State** - показать текущее состояние AI

---

## 🚀 **Преимущества Новой Архитектуры**

### **1. Разделение Ответственности:**
- **SpawnerTokens** - только данные и веса
- **SpawnerEnemysAI** - только AI логика
- **SpawnerEnemys** - только координация

### **2. Гибкость:**
- Легко отключить AI функции
- Настраиваемые параметры глюков
- Модульная архитектура

### **3. Отладка:**
- Визуальные инструменты отладки
- Принудительное тестирование
- Детальная информация о состоянии

### **4. Производительность:**
- AI логика вызывается только при необходимости
- Кэширование результатов
- Оптимизированные алгоритмы

---

## 🔧 **Использование**

### **Настройка в Unity:**
1. Добавить `SpawnerEnemysAI` компонент к объекту со спаунером
2. Настроить параметры глюков в Inspector
3. Включить/выключить AI функции
4. Использовать отладочные кнопки для тестирования

### **Программное Управление:**
```csharp
// Принудительный глюк
_spawnerAI.ForceGlitch();

// Принудительная смена цели
_spawnerAI.ForceRetarget();

// Получение информации о состоянии
Debug.Log($"Target: {_spawnerAI.CurrentTargetSection}");
Debug.Log($"Power: {_spawnerAI.CurrentSectionPower}");
```

---

## 🎯 **Результат**

✅ **AI логика вынесена** из токенов в отдельный компонент  
✅ **Система глюков** добавлена для непредсказуемости  
✅ **Архитектура упрощена** - четкое разделение ответственности  
✅ **Отладка улучшена** - визуальные инструменты и кнопки  
✅ **Производительность** - оптимизированная логика  

Система готова к использованию! 🚀
